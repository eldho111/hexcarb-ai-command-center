<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Accounting</title>
  <style>
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px; }
    table { margin-bottom: 1em; }
  </style>
</head>
<body>
  <h1>Accounting</h1>
  <table id="tx-table">
    <thead>
      <tr><th>ID</th><th>Date</th><th>Type</th><th>Amount</th><th>Note</th><th></th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 id="form-title">Create Transaction</h2>
  <form id="tx-form">
    <input type="hidden" id="tx-id" />
    <label>Date <input type="date" id="tx-date" required></label><br>
    <label>Type 
      <select id="tx-type">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </label><br>
    <label>Amount <input type="number" step="0.01" id="tx-amount" required></label><br>
    <label>Note <input type="text" id="tx-note"></label><br>
    <button type="submit">Save</button>
    <button type="button" id="cancel-edit" style="display:none;">Cancel</button>
  </form>

<script>
async function loadTransactions() {
  const res = await fetch('/api/accounting/', {headers:{'X-Role':'Admin'}});
  const data = await res.json();
  const tbody = document.querySelector('#tx-table tbody');
  tbody.innerHTML = '';
  data.forEach(tx => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${tx.id}</td><td>${tx.date}</td><td>${tx.type}</td><td>${tx.amount}</td><td>${tx.note}</td>` +
                   `<td><button onclick="editTx(${tx.id})">Edit</button></td>`;
    tbody.appendChild(tr);
  });
}

async function saveTx(e) {
  e.preventDefault();
  const id = document.getElementById('tx-id').value;
  const tx = {
    date: document.getElementById('tx-date').value,
    type: document.getElementById('tx-type').value,
    amount: parseFloat(document.getElementById('tx-amount').value),
    note: document.getElementById('tx-note').value
  };
  const opts = {
    method: id ? 'PUT' : 'POST',
    headers: {'Content-Type':'application/json','X-Role':'Admin'},
    body: JSON.stringify(tx)
  };
  const url = '/api/accounting/' + (id ? id : '');
  await fetch(url, opts);
  resetForm();
  loadTransactions();
}

function editTx(id) {
  fetch('/api/accounting/' + id, {headers:{'X-Role':'Admin'}})
    .then(r => r.json())
    .then(tx => {
      document.getElementById('form-title').textContent = 'Edit Transaction';
      document.getElementById('tx-id').value = tx.id;
      document.getElementById('tx-date').value = tx.date;
      document.getElementById('tx-type').value = tx.type;
      document.getElementById('tx-amount').value = tx.amount;
      document.getElementById('tx-note').value = tx.note;
      document.getElementById('cancel-edit').style.display = 'inline';
    });
}

function resetForm() {
  document.getElementById('form-title').textContent = 'Create Transaction';
  document.getElementById('tx-id').value = '';
  document.getElementById('tx-form').reset();
  document.getElementById('cancel-edit').style.display = 'none';
}

document.getElementById('tx-form').addEventListener('submit', saveTx);
document.getElementById('cancel-edit').addEventListener('click', resetForm);

loadTransactions();
</script>
</body>
</html>
